<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="box">
<title>Testing modules • box</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Testing modules">
<meta property="og:description" content="box">
<meta property="og:image" content="http://klmr.me/box/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">box</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/box.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>General topics</h6>
    <a class="dropdown-item" href="../articles/faq.html">Frequently asked questions</a>
    <a class="dropdown-item" href="../articles/testing.html">Testing modules</a>
    <a class="dropdown-item" href="../articles/compiled-code.html">Using compiled code</a>
    <a class="dropdown-item" href="../articles/migration.html">Migration guide for version 1.0</a>
    <a class="dropdown-item" href="../articles/related.html">Similar packages</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Implementation details</h6>
    <a class="dropdown-item" href="../articles/contributing.html">Contributing</a>
    <a class="dropdown-item" href="../articles/mod-env-hierarchy.html">The hierarchy of module environments</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/klmr/box/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Testing modules</h1>
                        <h4 data-toc-skip class="author">Konrad
Rudolph</h4>
            
            <h4 data-toc-skip class="date">2024-02-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/klmr/box/blob/main/vignettes/testing.rmd" class="external-link"><code>vignettes/testing.rmd</code></a></small>
      <div class="d-none name"><code>testing.rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="testing-is-crucial">Testing is crucial<a class="anchor" aria-label="anchor" href="#testing-is-crucial"></a>
</h2>
<p>Writing tests to ensure code correctness is a crucial part of
developing robust software. This is especially true for dynamic
languages such as R, which lack some of the tools that ensure
correctness in statically checked programming languages.</p>
<p>‘box’ does not dictate a specific style of testing, and different
kinds of testing are appropriate in different situations. However, the
following article suggests a structure for the test accompanying a
module which I have found to work well.</p>
<p>Following the suggested structure causes the implementation and the
tests of each module to be located in paths next to each other. This
structure is found in several other conventions across programming
languages; but it differs somewhat from the convention of R packages
(where all implementation code is in a separate directory from all
testing code), and differs drastically from the convention found for
instance in Java. That said, it should be possible to make a Java-like
test project work with ‘box’, too.</p>
</div>
<div class="section level2">
<h2 id="support-for-existing-testing-frameworks">Support for existing testing frameworks<a class="anchor" aria-label="anchor" href="#support-for-existing-testing-frameworks"></a>
</h2>
<p>‘box’ is agnostic regarding the testing framework. The following
example employs the widely used ‘<a href="https://testthat.r-lib.org/" class="external-link">testthat</a>’ unit testing package,
but other frameworks exist, and should also work.</p>
<p>This example uses the <a href="bio/seq.r"><code>bio/seq</code></a>
module from the <em><a href="box.html">Getting started</a></em>
vignette. To enable unit testing, this module contains the following
code at the very end:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/name.html">name</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">.</span><span class="op">/</span><span class="va">`__tests__`</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This allows us to run the tests by running the module source code
from the command line, e.g. via</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">Rscript</span> bio/seq.r</span></code></pre></div>
<p>… or inside an IDE such as RStudio by choosing the menu item “Tools”
› “Jobs” › “Start Local Job…” <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;It may be tempting to instead use the “Source” button
but doing so is problematic; see the section “A note on RStudio and
other IDEs”!&lt;/p&gt;"><sup>1</sup></a>. This works because <code><a href="../reference/name.html">box::name</a></code>
returns the name of the module from which this function is called. But
if the function is invoked from code that wasn’t loaded via
<code><a href="../reference/use.html">box::use</a></code> (as is the case here), its value is
<code>NULL</code>. In other words, <code>is.null(box::name())</code> is
a way of testing whether the code currently being run is loaded as a
module, or executed directly.</p>
<p>The code inside the <code>if</code> imports the
<code>__tests__</code> submodule: that’s where we put the unit tests.
The name <code>__tests__</code> is a convention. You’re free to choose a
different name, but I recommend sticking with this convention. Note that
<code>__tests__</code> is not a valid R variable name; that’s why it
needs to be written in backticks, i.e. the qualified local module name
is <code>./`__tests__`</code>.</p>
<p>In this case, the <code>__tests__</code> submodule consists of a
directory with the following contents:</p>
<ul>
<li>
<code>__tests__/</code>
<ul>
<li><a href="bio/__tests__/__init__.r"><code>__init__.r</code></a></li>
<li><a href="bio/__tests__/helper-module.r"><code>helper-module.r</code></a></li>
<li>individual test files</li>
</ul>
</li>
</ul>
<p>The <code>__init__.r</code> file corresponds closely to the file
<code>tests/testthat.R</code> in a standard R package structure. It
loads ‘testthat’ and launches the tests:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">testthat</span><span class="op">[</span><span class="va">...</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">.on_load</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">ns</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">test_dir</span><span class="op">(</span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/file.html">file</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/export.html">export</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This first loads and attaches the ‘testthat’ package. Although
attaching is not strictly necessary, ‘testthat’ code is a lot more
readable without cluttering the code with explicit name
qualifications.</p>
<p>Next it invokes <code>test_dir</code> and passes the tests’ directory
via <code><a href="../reference/file.html">box::file</a></code> inside the module’s <code>.on_load</code>
hook — remember that only declarations should be at file level inside a
module! All code execution should happen inside functions.</p>
<p>The <code>helper-module.r</code> file is a ‘testthat’ helper; these
are sourced automatically by ‘testthat’ in the environment where the
tests are run. We use this mechanism to load our module in the test
environment:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">..</span><span class="op">/</span><span class="va">seq</span><span class="op">[</span><span class="va">...</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>And, again, attaching isn’t strictly necessary here. Note also that,
depending on how the tests are run, this helper file might not be
needed, since executing the module script file itself already loads the
module contents into the global namespace; however, not all ways of
loading the tests do this; for instance, RStudio’s “Start Local Job”
doesn’t. So having this helper is sometimes necessary, and never
hurts.</p>
<p>With this set-up, the actual unit test files look exactly like
regular ‘testthat’ test files. For instance, here’s
<code>__tests__/test-seq.r</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">'valid sequences can be created'</span>, <span class="op">{</span></span>
<span>    <span class="fu">expect_error</span><span class="op">(</span><span class="op">(</span><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="st">'GATTACA'</span><span class="op">)</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="fu">expect_true</span><span class="op">(</span><span class="fu">is_valid</span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu">expect_error</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="st">'cattaga'</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">'invalid sequences cannot be created'</span>, <span class="op">{</span></span>
<span>    <span class="fu">expect_error</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="st">'GATTXA'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="a-note-on-rstudio-and-other-ides">A note on RStudio and other IDEs<a class="anchor" aria-label="anchor" href="#a-note-on-rstudio-and-other-ides"></a>
</h3>
<p>Most IDEs have an option to “Source” a local file. When doing this it
may <em>seem</em> as if the tests are correctly run, but this isn’t
actually the case! This is because <code><a href="../reference/use.html">box::use</a></code> doesn’t reload
code that has already been loaded previously; instead, it uses an
already loaded, cached version. This means that running the tests via
the “Source” button risks running an outdated version of the tests, or
the module, or both, after modifying their code.</p>
<p>To avoid this, always execute the test module in a new R session. In
RStudio, the easiest way of doing this is by running it as a job, via
the menu “Tools” › “Jobs” › “Start Local Job…” (or using the option
“Source as Local Job…” in the “Source” drop-down).</p>
</div>
</div>
<div class="section level2">
<h2 id="test-interfaces-not-implementation-details">Test interfaces, not implementation details<a class="anchor" aria-label="anchor" href="#test-interfaces-not-implementation-details"></a>
</h2>
<p>One big difference between testing module code and testing package
code is that, with the testing structure laid out above, the testing
code only sees the module’s public interface, it does not get access to
the internal module implementation.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Depending on how it’s invoked; but we shouldn’t make
assumptions. In particular, when invoked as a job in RStudio, the test
module is loaded via the test helper, and thus the module internals are
not visible.&lt;/p&gt;"><sup>2</sup></a></p>
<p>This is <em>by design</em>: the idea is that we want to test the
<em>observable behaviour</em> rather than the (purely incidental)
current implementation, which might be changed. This is the way unit
testing works in many other environments, and how it is often
recommended.</p>
<p>But I realise that this may not always be appropriate. Sometimes we
<em>need</em> to test implementation details. There are essentially two
workarounds for this. For the moment, I have not yet developed a strong
preference for either of these methods.</p>
<ol style="list-style-type: decimal">
<li>
<p>Put the tests into the module files themselves.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># mymod.r</span></span>
<span></span>
<span><span class="va">this_works</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="op">)</span> <span class="cn">TRUE</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/name.html">name</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">testthat</span><span class="op">[</span><span class="va">...</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Define tests</span></span>
<span></span>
<span>    <span class="fu">test_that</span><span class="op">(</span><span class="st">'implementation detail X works'</span>, <span class="op">{</span></span>
<span>        <span class="fu">expect_true</span><span class="op">(</span><span class="fu">this_works</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Invoke tests</span></span>
<span></span>
<span>    <span class="fu">test_file</span><span class="op">(</span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/file.html">file</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>Get access to the private module namespace for testing. When
loading a module with <code><a href="../reference/use.html">box::use</a></code>, the module object has an
attribute <code>namespace</code> that holds the private module
namespace. It generally shouldn’t be accessed by client code, but access
by the testing code for a module is entirely legitimate:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># __tests__/test-something.r</span></span>
<span></span>
<span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">..</span><span class="op">/</span><span class="va">mymod</span><span class="op">)</span></span>
<span></span>
<span><span class="va">impl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mymod</span>, <span class="st">'namespace'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">'implementation detail X works'</span>, <span class="op">{</span></span>
<span>    <span class="fu">expect_true</span><span class="op">(</span><span class="va">impl</span><span class="op">$</span><span class="fu">this_works</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://klmr.me" class="external-link">Konrad Rudolph</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
