<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Module environments • box</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Module environments">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">box</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/box.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>General topics</h6></li>
    <li><a class="dropdown-item" href="../articles/faq.html">Frequently asked questions</a></li>
    <li><a class="dropdown-item" href="../articles/testing.html">Testing modules</a></li>
    <li><a class="dropdown-item" href="../articles/compiled-code.html">Using compiled code</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration guide for version 1.0</a></li>
    <li><a class="dropdown-item" href="../articles/related.html">Similar packages</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes for developers</h6></li>
    <li><a class="dropdown-item" href="../articles/contributing.html">Contributing</a></li>
    <li><a class="dropdown-item" href="../articles/mod-envs.html">Module environments</a></li>
    <li><a class="dropdown-item" href="../articles/extract-benchmark.html">Module access benchmark</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/klmr/box/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Module environments</h1>
                        <h4 data-toc-skip class="author">Konrad
Rudolph</h4>
            
            <h4 data-toc-skip class="date">2024-08-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/klmr/box/blob/main/vignettes/mod-envs.rmd" class="external-link"><code>vignettes/mod-envs.rmd</code></a></small>
      <div class="d-none name"><code>mod-envs.rmd</code></div>
    </div>

    
    
<div class="dev-note">
<blockquote>
<p><strong>Note:</strong> This document describes internal
implementation details. They are not required knowledge for users of the
‘box’ package and module authors.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="preliminaries">Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<p>To ensure that module environments are properly isolates from each
other, and to enable fine-grained control over imports and exports,
loaded modules (as well as packages loaded via <code><a href="../reference/use.html">box::use</a></code>)
correspond to a mesh of several interconnected environments.</p>
<p>Unfortunately the exact relationship between these environments isn’t
trivial, so the following document aims at explaining the gist.</p>
<p>Fundamentally, module environments follow a similar architecture to
package environments, but they deviate in crucial ways. For a good
explanation of package environments, see <a href="https://blog.thatbuthow.com/how-r-searches-and-finds-stuff/" class="external-link"><em>How
R Searches and Finds Stuff</em></a> by Suraj Gupta, and <a href="http://adv-r.had.co.nz/Environments.html" class="external-link"><em>Environments</em></a>
in <em>Advanced R</em> by Hadley Wickham. The following assumes that the
reader has a more than passing familiarity with these concepts.</p>
<p>When speaking of “package environments” above and in the following,
this refers to packages as handled by base R and the R package namespace
functionality. For packages that are loaded by <code><a href="../reference/use.html">box::use</a></code>,
the rules are the same as for modules.</p>
<p>Let’s now consider an example of several loaded modules, and how they
interact.</p>
</div>
<div class="section level2">
<h2 id="an-example">An example<a class="anchor" aria-label="anchor" href="#an-example"></a>
</h2>
<p>This example will use three modules — the minimum number necessary to
show some of the interactions of the module environments. Let’s define
these three modules. We’ll do so in inverse order of their usage:</p>
<div class="section level3">
<h3 id="c-r">
<code><span style="background: #1DB100; color: white; padding: 0 5px; border-radius: 2px;">c.r</span></code><a class="anchor" aria-label="anchor" href="#c-r"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="va">f</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="op">)</span> <span class="st">'c$f'</span></span></code></pre></div>
<p>Module <code>c</code> defines and exports one name, the function
<code>f</code>.</p>
</div>
<div class="section level3">
<h3 id="b-r">
<code><span style="background: #FF9300; color: white; padding: 0 5px; border-radius: 2px;">b.r</span></code><a class="anchor" aria-label="anchor" href="#b-r"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="va">f</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="op">)</span> <span class="st">'b$f'</span></span>
<span></span>
<span><span class="va">g</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="op">)</span> <span class="st">'b$g'</span></span></code></pre></div>
<p>Module <code>b</code> defines and exports the function
<code>f</code>, and in addition defines the function <code>g</code>.</p>
</div>
<div class="section level3">
<h3 id="a-r">
<code><span style="background: #00A2FF; color: white; padding: 0 5px; border-radius: 2px;">a.r</span></code><a class="anchor" aria-label="anchor" href="#a-r"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">.</span><span class="op">/</span><span class="va">b</span><span class="op">[</span>g <span class="op">=</span> <span class="va">f</span>, <span class="va">...</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">.</span><span class="op">/</span><span class="va">c</span><span class="op">[</span><span class="va">...</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span><span class="va">.</span><span class="op">/</span><span class="va">c</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">f</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="op">)</span> <span class="st">'a$f'</span></span>
<span></span>
<span><span class="va">f_of_c1</span> <span class="op">=</span> <span class="va">c</span><span class="op">$</span><span class="va">f</span></span>
<span><span class="va">f_of_c2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="st">'f'</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">parent.env</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">f_of_c1</span>, <span class="va">f_of_c2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Module <code>a</code> imports and re-exports all names from
<code>b</code> (changing the name of <code>b$f</code> to
<code>g</code>); it also imports, but does not re-export, all names from
<code>c</code> (and, additionally, defines an alias for the module,
which it exports).</p>
<p>It further defines and exports the function <code>f</code> and
defines, but does not export, the functions <code>f_of_c1</code> and
<code>f_of_c2</code> (which are defined such that they are identical to
each other — hopefully it will become clear why later).</p>
<p>Finally, let’s use the modules by executing the following code:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">box</span><span class="fu">::</span><span class="fu"><a href="../reference/use.html">use</a></span><span class="op">(</span>a <span class="op">=</span> <span class="va">.</span><span class="op">/</span><span class="va">a</span><span class="op">[</span><span class="va">f</span>, <span class="va">g</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Now the name <code>a</code> is defined in <code>.GlobalEnv</code> and
refers to the module environment of module <code>a</code>. The exported
names <code>f</code> and <code>g</code> of <code>a</code> are also
available in <code>.GlobalEnv</code> (but not defined <em>inside</em>
<code>.GlobalEnv</code>).</p>
<p>The loaded modules can be represented by the following schematic,
with each box corresponding to an environment:</p>
<p><img src="environment-schema.png"></p>
<p>Let’s go over the different types of environment associated with each
module, and how they are connected.</p>
</div>
</div>
<div class="section level2">
<h2 id="environments">Environments<a class="anchor" aria-label="anchor" href="#environments"></a>
</h2>
<div class="section level3">
<h3 id="module-namespace">Module namespace<a class="anchor" aria-label="anchor" href="#module-namespace"></a>
</h3>
<p>Modules are loaded into their own dedicated environment, the
<em>module namespace</em>. Every name that is defined by a module is
defined inside it. It is thus also the enclosing environment of the
module’s functions. Lastly, the module namespace also stores
meta-information about the module in a hidden member named
<code>.__module__.</code>.</p>
<p>This corresponds to the package namespace.</p>
</div>
<div class="section level3">
<h3 id="module-imports-environment">Module imports environment<a class="anchor" aria-label="anchor" href="#module-imports-environment"></a>
</h3>
<p>The parent environment of the module namespace is the imports
environment, which contains all the names that a module imports via
attachment declarations in <code><a href="../reference/use.html">box::use</a></code> expressions.</p>
<p>The parent environment of the imports environment is the R
<code>base</code> namespace environment. The module imports environment
thus corresponds to the package imports environment.</p>
</div>
<div class="section level3">
<h3 id="module-export-environment">Module export environment<a class="anchor" aria-label="anchor" href="#module-export-environment"></a>
</h3>
<p>The module export environment, also called just “module environment”
in the code base, contains all names that are marked as exported by a
module. If users create a module alias in their <code><a href="../reference/use.html">box::use</a></code>
call, the alias will be a reference to this environment.</p>
<p>Similarly, attached names are selected as a subset from the module
export environment (then copied into the imports environment).</p>
<p>There is no direct equivalent to this environment in R packages,
because R packages do not distinguish between exported names and names
imported by the code that loaded the package. By contrast, ‘box’ needs
to distinguish the set of exports from the set of names that are
imported (= “attached”) by client code.</p>
</div>
<div class="section level3">
<h3 id="importing-into-other-environments">Importing into other environments<a class="anchor" aria-label="anchor" href="#importing-into-other-environments"></a>
</h3>
<p>Module import environments store imports from one or more module into
another. However, modules can also be imported from inside the global
environment, or from inside functions, which have their own local
execution environment (the stack frame). When this happens, a new
imports environment is created on the fly, and attached to the importing
environment’s <code>parent.env</code> chain. Calling
<code><a href="../reference/use.html">box::use</a></code> with a non-empty attach list in
<code>.GlobalEnv</code> is therefore similar to calling
<code>library</code>. In particular, inside <code>.GlobalEnv</code> the
call <code>box::use(pkg[...])</code> in pretty much equivalent to
calling <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library(pkg)</a></code>, and is discouraged for the same
reason that <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library(pkg)</a></code> is discouraged.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://klmr.me" class="external-link">Konrad Rudolph</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
