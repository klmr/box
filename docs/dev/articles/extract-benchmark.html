<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Module access benchmark • box</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Module access benchmark">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">box</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/box.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>General topics</h6></li>
    <li><a class="dropdown-item" href="../articles/faq.html">Frequently asked questions</a></li>
    <li><a class="dropdown-item" href="../articles/testing.html">Testing modules</a></li>
    <li><a class="dropdown-item" href="../articles/compiled-code.html">Using compiled code</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">Migration guide for version 1.0</a></li>
    <li><a class="dropdown-item" href="../articles/related.html">Similar packages</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes for developers</h6></li>
    <li><a class="dropdown-item" href="../articles/contributing.html">Contributing</a></li>
    <li><a class="dropdown-item" href="../articles/mod-envs.html">Module environments</a></li>
    <li><a class="dropdown-item" href="../articles/extract-benchmark.html">Module access benchmark</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/klmr/box/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Module access benchmark</h1>
                        <h4 data-toc-skip class="author">Konrad
Rudolph</h4>
            
            <h4 data-toc-skip class="date">2024-08-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/klmr/box/blob/main/vignettes/extract-benchmark.rmd" class="external-link"><code>vignettes/extract-benchmark.rmd</code></a></small>
      <div class="d-none name"><code>extract-benchmark.rmd</code></div>
    </div>

    
    
<div class="dev-note">
<blockquote>
<p><strong>Note:</strong> This document describes internal
implementation details. They are not required knowledge for users of the
‘box’ package and module authors.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="purpose">Purpose<a class="anchor" aria-label="anchor" href="#purpose"></a>
</h2>
<p>Accessing a name in a module via <code>$</code> is expected to be an
<em>extremely common</em> operation, and will happen in tight loops.
Performance is therefore crucial. Furthermore, <span class="pkg">box</span> overrides <code>$</code> for modules to prevent
partial matching (which the base R implementation does) and to provide
clean, relevant, informative error messages when a nonexistent name is
accessed.</p>
<p>This benchmark compares several implementations to choose the most
efficient one that still fulfils the design criteria.</p>
</div>
<div class="section level2">
<h2 id="scaffold">Scaffold<a class="anchor" aria-label="anchor" href="#scaffold"></a>
</h2>
<p>The following code generates mock modules for lookup with few and
many exported names as two representative cases. In fact, I don’t expect
there to be a big difference between them since even large modules will
typically have compartively few names (it might get more interesting
with thousands of names, but this isn’t a case we expect often, and
therefore don’t optimise for it).</p>
<p>And in fact using a hash table representation for typical module
sizes probably <em>adds</em> overhead; so we also test non-hashed
environments.</p>
<p>We will arbitrarily use <code><a href="https://rdrr.io/r/utils/head.html" class="external-link">utils::tail</a></code> as the value that is
exported from the test modules. The reason for this is so that we can
compare performance with that of a package export (via <code>::</code>)
and still allow the <span class="pkg">bench</span> package to validate
that all expressions return the same result (via implicit
<code>check = TRUE</code>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_module</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">class</span>, <span class="va">size</span>, <span class="va">hash</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">extra_objects</span> <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>        <span class="va">size</span>,</span>
<span>        small <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="co"># 50 arbitrary names ought to do:</span></span>
<span>        large <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">month.name</span>, <span class="va">month.abb</span>, <span class="va">letters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">objects</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">extra_objects</span>, name <span class="op">=</span> <span class="fu">utils</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list2env.html" class="external-link">list2env</a></span><span class="op">(</span><span class="va">objects</span>, parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">emptyenv</a></span><span class="op">(</span><span class="op">)</span>, hash <span class="op">=</span> <span class="va">hash</span><span class="op">)</span>,</span>
<span>        class <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">class</span> <span class="op">!=</span> <span class="st">'baseline'</span><span class="op">)</span> <span class="va">class</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Some setup for compiling and loading native code:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">load_native</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">oldwd</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="st">'extract'</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="va">oldwd</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">exitcode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2</a></span><span class="op">(</span><span class="st">'R'</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'CMD'</span>, <span class="st">'SHLIB'</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">name</span>, <span class="st">'.c'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">exitcode</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">dll_path</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">.Platform</span><span class="op">$</span><span class="va">dynlib.ext</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/getNativeSymbolInfo.html" class="external-link">getNativeSymbolInfo</a></span><span class="op">(</span><span class="va">name</span>, <span class="fu"><a href="https://rdrr.io/r/base/dynload.html" class="external-link">dyn.load</a></span><span class="op">(</span><span class="va">dll_path</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="implementations">Implementations<a class="anchor" aria-label="anchor" href="#implementations"></a>
</h2>
<div class="section level3">
<h3 id="extract">
<code>[[</code> extract<a class="anchor" aria-label="anchor" href="#extract"></a>
</h3>
<p>This serves as a comparison, but the semantics are wrong: it does not
raise an error for nonexistent names; instead it returns
<code>NULL</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_brackets`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">e1</span><span class="op">[[</span><span class="va">e2</span>, exact <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get">
<code>get</code><a class="anchor" aria-label="anchor" href="#get"></a>
</h3>
<p>The simplest compliant implementation, though it creates terrible
error messages:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_get`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">e2</span>, envir <span class="op">=</span> <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-trycatch">
<code>get</code> + <code>tryCatch</code><a class="anchor" aria-label="anchor" href="#get-trycatch"></a>
</h3>
<p>The following implementations avoid the error raised by
<code>get</code> for a nonexistent name and provide a better error
message. The messages below are placeholders — a real implementation
would trade time and complexity for a nicer error message (the
performance of the error case is irrelevant for us, so it is permitted
to be slow).</p>
<p>The first implementation catches the error raised by <code>get</code>
and raises a different error instead:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_try_catch_get`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">e2</span>, envir <span class="op">=</span> <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>        error <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'Nice error message'</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-in-names">
<code>get</code> + <code>%in% names(…)</code><a class="anchor" aria-label="anchor" href="#get-in-names"></a>
</h3>
<p>The next implementation adds an explicit check via lookup in the
<code>names</code> of the module environment:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_in_names_get`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="va">e2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">e1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'Nice error message'</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">e2</span>, envir <span class="op">=</span> <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-in-ls">
<code>get</code> + <code>%in% ls(…)</code><a class="anchor" aria-label="anchor" href="#get-in-ls"></a>
</h3>
<p>Instead of <code>names</code>, we can also use <code>ls</code> to
enumerate an environment’s name, but we need to remember to pass
<code>all.names = TRUE</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_in_ls_get`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="va">e2</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="va">e1</span>, all.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'Nice error message'</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">e2</span>, envir <span class="op">=</span> <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-hasname">
<code>get</code> + <code>hasName</code><a class="anchor" aria-label="anchor" href="#get-hasname"></a>
</h3>
<p><code>hasName(a, b)</code> does basically the same as
<code>b %in% names(a)</code> but its documentation claims that it is
more efficient:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_has_name_get`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/utils/hasName.html" class="external-link">hasName</a></span><span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'Nice error message'</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">e2</span>, envir <span class="op">=</span> <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-exists">
<code>get</code> + <code>exists</code><a class="anchor" aria-label="anchor" href="#get-exists"></a>
</h3>
<p>A more straightforward check for existence of a name in an
environment is <code>exists</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_exists_get`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="va">e2</span>, envir <span class="op">=</span> <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'Nice error message'</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">e2</span>, envir <span class="op">=</span> <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get0">
<code>get0</code><a class="anchor" aria-label="anchor" href="#get0"></a>
</h3>
<p>It would be great if the <code>ifnotfound</code> argument to
<code>get0</code> were lazily evaluated: we could pass the error
handling logic directly to <code>get0</code>, to be evaluated only in
the case of a nonexistent name. Alas, R does not indulge us. We
therefore need to use a sentinel value for <code>ifnotfound</code> which
is guaranteed to never be found in an actual module. Luckily this is
straightforward by using a new environment: R performs reference
identity checking for environments when passed to
<code>identical</code>, meaning that two environments compare
identically if and only if they result from the same creation via
<code>new.env</code> (in particular, two environments are <em>not</em>
identical just because they happen to contain the same — or no —
contents).</p>
<p>In the implementation below this environment is reused between
multiple invocations. In theory, an enterprising user <em>could</em>
extract this value from the innards of <span class="pkg">box</span> and
export it from their own module. But this wouldn’t happen by accident,
and they deserve what they get.</p>
<p>Luckily for us, checking whether two environments are identical is
also efficient (R just compares their pointers):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_get0`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ret</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">get0</a></span><span class="op">(</span><span class="va">e2</span>, <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span>, ifnotfound <span class="op">=</span> <span class="va">mod_get0_sentinel</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">ret</span>, <span class="va">mod_get0_sentinel</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'Nice error message'</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">ret</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mod_get0_sentinel</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get0-with-handler-in-on-exit">
<code>get0</code> with handler in <code>on.exit</code><a class="anchor" aria-label="anchor" href="#get0-with-handler-in-on-exit"></a>
</h3>
<p>We can avoid a temporary variable for the return value of
<code>get0</code> by moving the sentinel check into the
<code>on.exit</code> handler. I find this rather elegant, but I also
suspect that it would be a lot less efficient:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_on_exit_get0`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">returnValue</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">mod_get0_sentinel</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">'Nice error message'</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">get0</a></span><span class="op">(</span><span class="va">e2</span>, <span class="va">e1</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span>, ifnotfound <span class="op">=</span> <span class="va">mod_get0_sentinel</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="call-native-code">
<code>.Call</code> native code<a class="anchor" aria-label="anchor" href="#call-native-code"></a>
</h3>
<p>Finally, we move to native code implementations. The actual lookup
implementation is always the same:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>SEXP f<span class="op">(</span>SEXP e1<span class="op">,</span> SEXP e2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    SEXP name <span class="op">=</span> Rf_installTrChar<span class="op">(</span>STRING_ELT<span class="op">(</span>e2<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    SEXP ret <span class="op">=</span> Rf_findVarInFrame<span class="op">(</span>e1<span class="op">,</span> name<span class="op">);</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> R_UnboundValue<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>        <span class="co">// handle nonexistent name</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The first implementation is an unadorned <code>.Call</code>
dispatch:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_call`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="va">.c_call</span>, <span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.c_call</span> <span class="op">=</span> <span class="fu">load_native</span><span class="op">(</span><span class="st">'call'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="call-native-code-with-environment-argument">
<code>.Call</code> native code with <code>environment</code>
argument<a class="anchor" aria-label="anchor" href="#call-native-code-with-environment-argument"></a>
</h3>
<p>To generate nicer error messages, it is tempting to pass additional
information to the call (in particular, the calling environment):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_call_env`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call</a></span><span class="op">(</span><span class="va">.c_call_env</span>, <span class="va">e1</span>, <span class="va">e2</span>, <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.c_call_env</span> <span class="op">=</span> <span class="fu">load_native</span><span class="op">(</span><span class="st">'call_env'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="external-native-code">
<code>.External</code> native code<a class="anchor" aria-label="anchor" href="#external-native-code"></a>
</h3>
<p>An alternative way of invoking native code is via
<code>.External</code>, which looks the same on the calling (R) side of
things:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_external`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.External</a></span><span class="op">(</span><span class="va">.c_external</span>, <span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.c_external</span> <span class="op">=</span> <span class="fu">load_native</span><span class="op">(</span><span class="st">'external'</span><span class="op">)</span></span></code></pre></div>
<p>The only difference is that we need to manually unpack the arguments
from the pairlist on the C side:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>SEXP e1 <span class="op">=</span> CADR<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>SEXP e2 <span class="op">=</span> CADDR<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">// etc.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="external-native-code-with-environment-argument">
<code>.External</code> native code with <code>environment</code>
argument<a class="anchor" aria-label="anchor" href="#external-native-code-with-environment-argument"></a>
</h3>
<p>And once again, with an extra argument for better context in the
error message:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`$.mod_external_env`</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.External</a></span><span class="op">(</span><span class="va">.c_external_env</span>, <span class="va">e1</span>, <span class="va">e2</span>, <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">.c_external_env</span> <span class="op">=</span> <span class="fu">load_native</span><span class="op">(</span><span class="st">'external_env'</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="benchmark">Benchmark<a class="anchor" aria-label="anchor" href="#benchmark"></a>
</h2>
<p>The following distinguishes “default”, where no class has been
assigned to the module (and thus the built-in environment type is used)
and where an S3 class is assigned but no <code>$</code> implement, so
that the S3 dispatch falls back to the default implementation. All other
methods are dispatched to a specific, custom method implementation of
the <code>$</code> generic. For good measure we also compare to
qualified name lookup in a package via <code>::</code>.</p>
<p>Before looking at the results, it is helpful to write down our
expectations, based on intuition and knowledge of the implementation of
the various methods. This will allow us to verify, to some extent, our
mental model of the R evaluation:</p>
<p>“baseline” and “default” will probably be the fastest cases since all
the work being done happens deep inside the R interpreter in native
code. It remains to be seen if our own native code implementation can
match their performance (<em>in principle</em> it could even surpass it,
since it needs to do less work by not performing partial matching).
There might also be a special case for “baseline” (where no S3 class is
assigned), and R might not perform S3 dispatch in this case at all.</p>
<p><code>[[</code> and <code>get</code> both directly invoke native code
(<code>[[</code> via <code>.Primitive</code> and <code>get</code> via
<code>.Internal</code>). However, <code>[[</code> can perform S3
dispatch so it might be somewhat slower. Then again, <code>get</code>
has more arguments that might need to be evaluated eagerly.</p>
<p>Handling errors explicitly will inevitably add overhead. By looking
at the implementations, <code>tryCatch</code> adds a fair bit of R code.
On the opposite side, <code>names</code> is a primitive function, and
<code>%in%</code> (via <code>match</code>) is an internal function; but,
compared to <code>tryCatch</code>, the <code>%in%</code> check is
performing a <em>redundant</em> test, so I have no clear expectation of
what method should be faster. <code>ls</code>, on the other hand,
contains a non-trivial amount of R logic, so I’d expect it to be
strictly slower than <code>names</code>. The documentation of
<code>hasName</code> claims that it is more efficient than
<code>%in%</code> + <code>names</code> but given its straightforward
implementation I don’t see how that is possible.</p>
<p>Of all the ways of redundantly checking for nonexistent names,
<code>exists</code> should be the fastest since it is implemented as an
<code>.Internal</code> function and is more direct than the other ways;
in particular, it can take advantage of the internal hash table
structure of the environment, which none of the other methods can;
however, this should only be an advantage for unrealistically large
modules. For real-world modules, using a hash table for the environment
probably makes no difference for lookup (at worst it might actually
<em>add</em> a small overhead compared to linear scanning!).</p>
<p><code>get0</code> is interesting: the documentation states that it is
more efficient than <code>exists</code> + <code>get</code>, but the
documentation only addresses the case where
<code>ifnotfound = NULL</code>, which cannot be used here
(<code>NULL</code> is a legitimate value to export from a module!). Is
it still more efficient when calling <code>identical</code> with an
environment instead of <code>is.null</code>?</p>
<p>… using <code>on.exit</code> to handle the sentinel value is almost
certainly going to be slower than doing it directly.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    baseline <span class="op">=</span> <span class="st">'baseline'</span>,</span>
<span>    default <span class="op">=</span> <span class="st">'default'</span>,</span>
<span>    brackets <span class="op">=</span> <span class="st">'[['</span>,</span>
<span>    get <span class="op">=</span> <span class="st">'get'</span>,</span>
<span>    try_catch_get <span class="op">=</span> <span class="st">'get + tryCatch'</span>,</span>
<span>    in_names_get <span class="op">=</span> <span class="st">'get + %in% names'</span>,</span>
<span>    in_ls_get <span class="op">=</span> <span class="st">'get + %in% ls'</span>,</span>
<span>    has_name_get <span class="op">=</span> <span class="st">'get + hasName'</span>,</span>
<span>    exists_get <span class="op">=</span> <span class="st">'get + exists'</span>,</span>
<span>    get0 <span class="op">=</span> <span class="st">'get0'</span>,</span>
<span>    on_exit_get0 <span class="op">=</span> <span class="st">'get0 + on.exit'</span>,</span>
<span>    call <span class="op">=</span> <span class="st">'.Call'</span>,</span>
<span>    call_env <span class="op">=</span> <span class="st">'.Call + env'</span>,</span>
<span>    external <span class="op">=</span> <span class="st">'.External'</span>,</span>
<span>    external_env <span class="op">=</span> <span class="st">'.External + env'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">classes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cases</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>    size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'small'</span>, <span class="st">'large'</span><span class="op">)</span>,</span>
<span>    hash <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">hash_label</span> <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">hash</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'hash'</span>, <span class="st">'vec'</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">hash</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">modules</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="kw">function</span> <span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">size</span> <span class="op">=</span> <span class="va">cases</span><span class="op">$</span><span class="va">size</span><span class="op">[</span><span class="va">row</span><span class="op">]</span></span>
<span>        <span class="va">hash</span> <span class="op">=</span> <span class="va">cases</span><span class="op">$</span><span class="va">hash</span><span class="op">[</span><span class="va">row</span><span class="op">]</span></span>
<span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'mod_'</span>, <span class="va">classes</span><span class="op">)</span>, <span class="va">create_module</span>, <span class="va">size</span>, <span class="va">hash</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">classes</span>, <span class="st">'_'</span>, <span class="va">size</span>, <span class="st">'_'</span>, <span class="fu">hash_label</span><span class="op">(</span><span class="va">hash</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list2env.html" class="external-link">list2env</a></span><span class="op">(</span><span class="va">modules</span>, <span class="va">.GlobalEnv</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="kw">function</span> <span class="op">(</span><span class="va">row</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">size</span> <span class="op">=</span> <span class="va">cases</span><span class="op">$</span><span class="va">size</span><span class="op">[</span><span class="va">row</span><span class="op">]</span></span>
<span>        <span class="va">hash</span> <span class="op">=</span> <span class="va">cases</span><span class="op">$</span><span class="va">hash</span><span class="op">[</span><span class="va">row</span><span class="op">]</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">'%s;%s;%s'</span>, <span class="va">labels</span>, <span class="va">size</span>, <span class="fu">hash_label</span><span class="op">(</span><span class="va">hash</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">exprs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">modules</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">mod</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/name.html" class="external-link">as.name</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="va">combined_labels</span></span>
<span><span class="op">)</span></span>
<span><span class="va">all_exprs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exprs</span>, `package;;;` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu">utils</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bm</span> <span class="op">=</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="http://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">1e5</span>, memory <span class="op">=</span> <span class="cn">FALSE</span>, time_unit <span class="op">=</span> <span class="st">'us'</span>, exprs <span class="op">=</span> <span class="va">all_exprs</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">method</th>
<th align="left">size</th>
<th align="left">hash</th>
<th align="right">median [µs]</th>
<th align="right">itr/sec</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">baseline</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.29</td>
<td align="right">3489635.88</td>
</tr>
<tr class="even">
<td align="left">default</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.29</td>
<td align="right">3539284.27</td>
</tr>
<tr class="odd">
<td align="left">[[</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.78</td>
<td align="right">1221066.60</td>
</tr>
<tr class="even">
<td align="left">get</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.90</td>
<td align="right">1059453.67</td>
</tr>
<tr class="odd">
<td align="left">get + tryCatch</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">3.36</td>
<td align="right">293050.98</td>
</tr>
<tr class="even">
<td align="left">get + %in% names</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">1.68</td>
<td align="right">575650.71</td>
</tr>
<tr class="odd">
<td align="left">get + %in% ls</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">4.55</td>
<td align="right">216477.46</td>
</tr>
<tr class="even">
<td align="left">get + hasName</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">1.72</td>
<td align="right">573462.93</td>
</tr>
<tr class="odd">
<td align="left">get + exists</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">1.52</td>
<td align="right">641379.55</td>
</tr>
<tr class="even">
<td align="left">get0</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">1.15</td>
<td align="right">835082.82</td>
</tr>
<tr class="odd">
<td align="left">get0 + on.exit</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">1.85</td>
<td align="right">521778.01</td>
</tr>
<tr class="even">
<td align="left">.Call</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.49</td>
<td align="right">1871681.15</td>
</tr>
<tr class="odd">
<td align="left">.Call + env</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.66</td>
<td align="right">1435698.64</td>
</tr>
<tr class="even">
<td align="left">.External</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.57</td>
<td align="right">1668291.51</td>
</tr>
<tr class="odd">
<td align="left">.External + env</td>
<td align="left">small</td>
<td align="left">hash</td>
<td align="right">0.74</td>
<td align="right">1312434.74</td>
</tr>
<tr class="even">
<td align="left">baseline</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.29</td>
<td align="right">3516050.71</td>
</tr>
<tr class="odd">
<td align="left">default</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.29</td>
<td align="right">3539194.63</td>
</tr>
<tr class="even">
<td align="left">[[</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.78</td>
<td align="right">1225400.04</td>
</tr>
<tr class="odd">
<td align="left">get</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.90</td>
<td align="right">1052159.55</td>
</tr>
<tr class="even">
<td align="left">get + tryCatch</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">3.32</td>
<td align="right">295900.61</td>
</tr>
<tr class="odd">
<td align="left">get + %in% names</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">2.05</td>
<td align="right">464525.59</td>
</tr>
<tr class="even">
<td align="left">get + %in% ls</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">21.20</td>
<td align="right">46855.49</td>
</tr>
<tr class="odd">
<td align="left">get + hasName</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">2.09</td>
<td align="right">458174.87</td>
</tr>
<tr class="even">
<td align="left">get + exists</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">1.52</td>
<td align="right">648668.06</td>
</tr>
<tr class="odd">
<td align="left">get0</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">1.15</td>
<td align="right">834118.10</td>
</tr>
<tr class="even">
<td align="left">get0 + on.exit</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">1.89</td>
<td align="right">511064.75</td>
</tr>
<tr class="odd">
<td align="left">.Call</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.49</td>
<td align="right">1883297.31</td>
</tr>
<tr class="even">
<td align="left">.Call + env</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.66</td>
<td align="right">1475727.57</td>
</tr>
<tr class="odd">
<td align="left">.External</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.57</td>
<td align="right">1516194.56</td>
</tr>
<tr class="even">
<td align="left">.External + env</td>
<td align="left">large</td>
<td align="left">hash</td>
<td align="right">0.74</td>
<td align="right">1315889.22</td>
</tr>
<tr class="odd">
<td align="left">baseline</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.29</td>
<td align="right">3548406.72</td>
</tr>
<tr class="even">
<td align="left">default</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.25</td>
<td align="right">3480764.23</td>
</tr>
<tr class="odd">
<td align="left">[[</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.78</td>
<td align="right">1233806.82</td>
</tr>
<tr class="even">
<td align="left">get</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.90</td>
<td align="right">1054789.91</td>
</tr>
<tr class="odd">
<td align="left">get + tryCatch</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">3.36</td>
<td align="right">296123.09</td>
</tr>
<tr class="even">
<td align="left">get + %in% names</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">1.64</td>
<td align="right">512267.85</td>
</tr>
<tr class="odd">
<td align="left">get + %in% ls</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">4.47</td>
<td align="right">221682.95</td>
</tr>
<tr class="even">
<td align="left">get + hasName</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">1.64</td>
<td align="right">595038.61</td>
</tr>
<tr class="odd">
<td align="left">get + exists</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">1.52</td>
<td align="right">648636.89</td>
</tr>
<tr class="even">
<td align="left">get0</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">1.15</td>
<td align="right">838683.63</td>
</tr>
<tr class="odd">
<td align="left">get0 + on.exit</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">1.89</td>
<td align="right">521859.01</td>
</tr>
<tr class="even">
<td align="left">.Call</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.49</td>
<td align="right">1895419.62</td>
</tr>
<tr class="odd">
<td align="left">.Call + env</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.66</td>
<td align="right">1161123.90</td>
</tr>
<tr class="even">
<td align="left">.External</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.57</td>
<td align="right">1669199.27</td>
</tr>
<tr class="odd">
<td align="left">.External + env</td>
<td align="left">small</td>
<td align="left">vec</td>
<td align="right">0.74</td>
<td align="right">1246779.28</td>
</tr>
<tr class="even">
<td align="left">baseline</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.25</td>
<td align="right">3552765.11</td>
</tr>
<tr class="odd">
<td align="left">default</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.25</td>
<td align="right">3567054.53</td>
</tr>
<tr class="even">
<td align="left">[[</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.78</td>
<td align="right">1227123.61</td>
</tr>
<tr class="odd">
<td align="left">get</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.90</td>
<td align="right">1076941.94</td>
</tr>
<tr class="even">
<td align="left">get + tryCatch</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">3.36</td>
<td align="right">295023.72</td>
</tr>
<tr class="odd">
<td align="left">get + %in% names</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">1.89</td>
<td align="right">506778.49</td>
</tr>
<tr class="even">
<td align="left">get + %in% ls</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">20.75</td>
<td align="right">47525.59</td>
</tr>
<tr class="odd">
<td align="left">get + hasName</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">1.93</td>
<td align="right">493022.78</td>
</tr>
<tr class="even">
<td align="left">get + exists</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">1.52</td>
<td align="right">643652.62</td>
</tr>
<tr class="odd">
<td align="left">get0</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">1.15</td>
<td align="right">834105.11</td>
</tr>
<tr class="even">
<td align="left">get0 + on.exit</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">1.89</td>
<td align="right">516868.57</td>
</tr>
<tr class="odd">
<td align="left">.Call</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.49</td>
<td align="right">1895057.14</td>
</tr>
<tr class="even">
<td align="left">.Call + env</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.66</td>
<td align="right">1467177.52</td>
</tr>
<tr class="odd">
<td align="left">.External</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.57</td>
<td align="right">1564559.73</td>
</tr>
<tr class="even">
<td align="left">.External + env</td>
<td align="left">large</td>
<td align="left">vec</td>
<td align="right">0.74</td>
<td align="right">1310190.20</td>
</tr>
<tr class="odd">
<td align="left">package</td>
<td align="left"></td>
<td align="left"></td>
<td align="right">0.04</td>
<td align="right">20249820.36</td>
</tr>
</tbody>
</table>
<p>Some observations:</p>
<ul>
<li>R code is <em>slow</em>, so any method that executes lots of it is
slower than the alternatives which execute less of it. This doesn’t come
as a big surprise, but the extent is still striking.</li>
<li>It is reassuring to see that <code>hasName</code> is in fact
identical in performance to <code>%in%</code> + <code>names</code>,
contrary to what its documentation claims.</li>
<li>All methods are <strong>substantially</strong> slower than the
built-in lookup. This is disappointing: it adds a non-negligible,
unavoidable overhead to every single qualified name lookup.</li>
<li>Worse, even the best implementation is an order of magnitude slower
than package name lookup via <code>::</code>, despite the fact that the
latter first needs to check whether the package is already loaded. It’s
great that <code>::</code> is fast, it’s not great that we are prevented
from getting the same performance.</li>
<li>Adding more arguments to the native calls adds a significant
overhead: it makes them around 1.31±0.03 (±SD) times slower, and this is
true for both the <code>.Call</code> and the <code>.External</code>
calling conventions.</li>
<li>Using a hashed <em>vs.</em> unhashed environment makes virtually no
difference, except a small one when checking via <code>%in%</code> +
<code>names</code>.</li>
</ul>
<div class="section level3">
<h3 id="correctness-check">Correctness check<a class="anchor" aria-label="anchor" href="#correctness-check"></a>
</h3>
<p>Ensure all of them (except for the baseline cases) throw an error
when an invalid name is queried:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">invalid_exprs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">exprs</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu">`[[&lt;-`</span><span class="op">(</span><span class="va">e</span>, <span class="fl">3L</span>, <span class="fu"><a href="https://rdrr.io/r/base/name.html" class="external-link">as.name</a></span><span class="op">(</span><span class="st">'nam'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">self</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">exclude</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">'^(baseline|default|\\[\\[);'</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">invalid_exprs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">did_call_stop</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>    <span class="va">invalid_exprs</span><span class="op">[</span><span class="op">!</span> <span class="va">exclude</span><span class="op">]</span>,</span>
<span>    <span class="kw">function</span> <span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">e</span>, <span class="va">self</span><span class="op">)</span>; <span class="cn">FALSE</span><span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span> <span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">did_call_stop</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="trailer">Trailer<a class="anchor" aria-label="anchor" href="#trailer"></a>
</h2>
<details><summary><code>sessionInfo()</code> output
</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.3.3 (2024-02-29)</span></span>
<span><span class="co">## Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Monterey 12.7.5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_GB.UTF-8/UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: Europe/Zurich</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] vctrs_0.6.5        cli_3.6.3          knitr_1.48         rlang_1.1.4       </span></span>
<span><span class="co">##  [5] xfun_0.46          bench_1.1.3        textshaping_0.4.0  jsonlite_1.8.8    </span></span>
<span><span class="co">##  [9] glue_1.7.0         htmltools_0.5.8.1  ragg_1.3.2         sass_0.4.9        </span></span>
<span><span class="co">## [13] fansi_1.0.6        rmarkdown_2.27     tibble_3.2.1       evaluate_0.24.0   </span></span>
<span><span class="co">## [17] jquerylib_0.1.4    fastmap_1.2.0      yaml_2.3.10        lifecycle_1.0.4   </span></span>
<span><span class="co">## [21] compiler_4.3.3     fs_1.6.4           pkgconfig_2.0.3    htmlwidgets_1.6.4 </span></span>
<span><span class="co">## [25] systemfonts_1.1.0  digest_0.6.36      R6_2.5.1           utf8_1.2.4        </span></span>
<span><span class="co">## [29] pillar_1.9.0       magrittr_2.0.3     bslib_0.8.0        tools_4.3.3       </span></span>
<span><span class="co">## [33] pkgdown_2.1.0.9000 cachem_1.1.0       desc_1.4.3</span></span></code></pre>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://klmr.me" class="external-link">Konrad Rudolph</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
