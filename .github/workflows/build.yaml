name: Build

on:
  push:
    branches: $default-branch

    jobs:
      build:
        name: Build
        runs-on: ubuntu-latest

        steps:
          - name: Check out code
            uses: actions/checkout@v2

          - name: Set up R
            uses: r-lib/actions/setup-r@v1

          - name: Cache R library
            uses: actions/cache@v2
            with:
              path: ${{ env.R_LIBS_USER }}
              key: ${{ hashFiles('.github/R-version') }}-1-${{ hashFiles('.github/depends.Rds') }}

          - name: Install dependencies
            run: |
              install.packages(c('remotes', 'rcmdcheck'))
              remotes::install_deps(dependencies = TRUE)
            shell: Rscript {0}

          - name: Build package
            run: |
              # Workaround for bug #1070 in roxygen2 7.1.0
              writeLines('# Generated by roxygen2: do not edit by hand', 'NAMESPACE')
              devtools::document()
            shell: Rscript {0}

          - name: Commit development build
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            run: |
              git config user.name klmr
              git config user.email klmr@users.noreply.github.com
              git remote set-url --push origin https://klmr:$GITHUB_TOKEN@github.com/klmr/box.git
              git branch -D devel || :
              git checkout -b devel
              git add --force NAMESPACE doc
              git commit -m 'Create a development release'
              git push --force --set-upstream origin devel
